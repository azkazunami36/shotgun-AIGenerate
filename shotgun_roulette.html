<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ショットガン・ルーレット（デジタル版 ver.α0.10 / solid build）</title>
<style>
  :root{
    --bg:#111; --panel:#1b1b1b; --sub:#141414; --text:#eee; --muted:#bbb;
    --chip:#222; --accent:#1b5b3b; --danger:#5b1b1b;
    --bg-image:none; --panel-image:none; --flash-color:#ffffff;
  }
  *{box-sizing:border-box;}
  body{
    font-family: "Yu Gothic UI", "Hiragino Kaku Gothic ProN", "Meiryo", system-ui, sans-serif;
    background:var(--bg);
    background-image: var(--bg-image);
    background-size:cover; background-position:center; background-attachment:fixed;
    color:var(--text); padding:16px; margin:0;
  }
  h1{margin:0 0 12px 0; font-size:20px;}
  .controls, .game {display:flex; gap:16px; margin-bottom:12px; flex-wrap:wrap;}
  .panel{
    background:var(--panel);
    background-image: var(--panel-image);
    background-size:cover; background-position:center;
    padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.6); min-width:220px;
  }
  label{display:block; margin-bottom:6px; font-size:13px; color:#ccc;}
  input, select, button{padding:6px 8px; border-radius:6px; border:1px solid #333; background:#121212; color:var(--text);}
  button{cursor:pointer;}
  .players{display:flex; gap:12px; flex-wrap:wrap;}
  .player{padding:8px; border-radius:6px; background:var(--sub); min-width:200px; display:grid; grid-template-columns:48px 1fr; grid-gap:8px; align-items:center;}
  .player.dead{opacity:0.35; text-decoration:line-through;}
  .avatar{width:48px; height:48px; border-radius:6px; background:#000 center/cover no-repeat;}
  .hp{font-weight:700; color:#ffb3b3;}
  .items{margin-top:8px;}
  .item{display:inline-flex; align-items:center; gap:6px; padding:4px 6px; margin:4px 4px 0 0; background:var(--chip); border-radius:6px; font-size:13px;}
  .item .icon{width:16px; height:16px; background:center/cover no-repeat;}
  .log{height:240px; overflow:auto; background:#0f0f0f; padding:8px; border-radius:6px; font-size:13px;}
  .chamber{font-size:13px; color:#ccc; margin-top:8px;}
  .big{font-size:16px;}
  .actions{margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;}
  .target-select{width:100%;}
  .peek-indicator{font-weight:700; color:#ffd27f;}
  footer{margin-top:12px; font-size:12px; color:#888;}
  .btn-danger{background:var(--danger);}
  .btn-primary{background:var(--accent);}
  .toolbar{display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;}

  /* タイトル */
  #titleScreen{
    position:fixed; inset:0; z-index:1000;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:radial-gradient(1200px 800px at 50% 40%, #222 0%, #000 70%);
    color:#f5f5f5; text-align:center;
  }
  #titleScreen h1{font-size:40px; letter-spacing:1px; margin:0;}
  #titleScreen p{margin:8px 0 0 0; color:#d0d0d0;}
  #startBtnTitle{margin-top:24px; padding:12px 24px; font-size:18px; border:1px solid #333; background:#162b22;}

  /* フラッシュ */
  #flashOverlay{ position:fixed; inset:0; background:var(--flash-color); opacity:0; pointer-events:none; z-index:999; }
  @keyframes flashEffect{ 0%{opacity:0;} 15%{opacity:1;} 100%{opacity:0;} }

  /* 設定モーダル */
  #settingsModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1100; }
  #settingsBackdrop{position:absolute; inset:0; background:rgba(0,0,0,0.6);}
  #settingsPanel{position:relative; background:#1a1a1a; border:1px solid #333; border-radius:10px; padding:16px; width:min(980px,94vw); max-height:90vh; overflow:auto; box-shadow:0 10px 40px rgba(0,0,0,0.8);}
  #settingsPanel h2{margin:0 0 8px 0; font-size:18px;}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .preview{width:100%; height:120px; background:#000 center/cover no-repeat; border-radius:6px; border:1px solid #333;}
  .help{font-size:12px; color:#aaa;}
  .small{font-size:12px;}
  .icon-preview{width:24px; height:24px; background:#000 center/cover no-repeat; border-radius:4px; border:1px solid #333; display:inline-block; vertical-align:middle;}

  /* 音量スライダー */
  .volrow{display:flex; align-items:center; gap:8px;}
  .volrow input[type=range]{flex:1;}
</style>
</head>
<body>

  <!-- タイトル画面 -->
  <div id="titleScreen">
    <h1>ショットガン・ルーレット</h1>
    <p>digital edition — ver.α0.10（assets + localStorage + volume）</p>
    <button id="startBtnTitle">START</button>
    <div class="small" style="margin-top:6px;">※最初のクリックでサウンドを有効化</div>
  </div>

  <!-- フラッシュ演出 -->
  <div id="flashOverlay"></div>

  <!-- 設定モーダル（assetsを基準、localStorageで上書き） -->
  <div id="settingsModal">
    <div id="settingsBackdrop"></div>
    <div id="settingsPanel">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h2>UI画像・テーマ設定（assets → localStorage 上書き）</h2>
        <div>
          <button id="presetDefault" class="small">プリセット: デフォルト</button>
          <button id="presetWood" class="small">プリセット: 木目</button>
          <button id="closeSettings" class="small">閉じる</button>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <h3 style="margin:0 0 8px 0;">サウンド設定</h3>
          <div class="row small">弾発射やクリック音の音源URL（assets設定 or data URL も可）。</div>
          <div class="row">
            <label style="width:60px;">空包</label><input id="sndBlankUrl" type="url" placeholder="空包音…" style="flex:1;">
          </div>
          <div class="row">
            <label style="width:60px;">実弾</label><input id="sndLiveUrl" type="url" placeholder="実弾音…" style="flex:1;">
          </div>
          <div class="row">
            <label style="width:60px;">クリック</label><input id="sndClickUrl" type="url" placeholder="クリック音…" style="flex:1;">
          </div>
          <div class="row volrow">
            <span>Master</span><input id="volMaster" type="range" min="0" max="1" step="0.01"><span id="volMasterLabel" class="small">100%</span>
          </div>
          <div class="row volrow">
            <span>空包</span><input id="volBlank" type="range" min="0" max="1" step="0.01"><span id="volBlankLabel" class="small">100%</span>
          </div>
          <div class="row volrow">
            <span>実弾</span><input id="volLive" type="range" min="0" max="1" step="0.01"><span id="volLiveLabel" class="small">100%</span>
          </div>
          <div class="row volrow">
            <span>クリック</span><input id="volClick" type="range" min="0" max="1" step="0.01"><span id="volClickLabel" class="small">100%</span>
          </div>
          <div class="row"><button id="soundsApply">サウンド適用</button> <button id="testBlank">空包テスト</button> <button id="testLive">実弾テスト</button> <button id="testClick">クリックテスト</button></div>
          <div class="small">※再生されない場合は、タイトル画面の START を押してからテストしてください（自動再生制限）。</div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 8px 0;">背景画像</h3>
          <div class="row">
            <input id="bgUrl" type="url" placeholder="画像URL / data URL…" style="flex:1;">
            <button id="bgApply">適用</button>
          </div>
          <div class="preview" id="bgPreview"></div>
          <div class="help">ローカル画像は data URL で貼り付け可（localStorage上限に注意）。</div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 8px 0;">パネル背景</h3>
          <div class="row">
            <input id="panelUrl" type="url" placeholder="画像URL / data URL…" style="flex:1;">
            <button id="panelApply">適用</button>
          </div>
          <div class="preview" id="panelPreview"></div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 8px 0;">フラッシュ色</h3>
          <div class="row">
            <input id="flashColor" type="color" value="#ffffff">
            <button id="flashTest">テスト</button>
          </div>
          <div class="help">実弾時に画面が点滅する色。</div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 8px 0;">プレイヤーアバター</h3>
          <div class="row small">P1〜P4のURL / data URL を保存。<b>localStorage が assets より常に優先</b>。</div>
          <div class="row"><span class="icon-preview" id="p1Prev"></span><input id="p1Url" type="url" placeholder="P1画像…" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="p2Prev"></span><input id="p2Url" type="url" placeholder="P2画像…" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="p3Prev"></span><input id="p3Url" type="url" placeholder="P3画像…" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="p4Prev"></span><input id="p4Url" type="url" placeholder="P4画像…" style="flex:1;"></div>
          <div class="row"><button id="avatarsApply">アバター適用</button></div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 8px 0;">アイテムアイコン</h3>
          <div class="row small">各アイテム名に対応する画像URL / data URL。</div>
          <div class="row"><span class="icon-preview" id="icoSawPrev"></span><input id="icoSaw" type="url" placeholder="ノコギリ…" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="icoGlassPrev"></span><input id="icoGlass" type="url" placeholder="拡大鏡…" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="icoBeerPrev"></span><input id="icoBeer" type="url" placeholder="ビール…" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="icoSmokePrev"></span><input id="icoSmoke" type="url" placeholder="タバコ…" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="icoCuffPrev"></span><input id="icoCuff" type="url" placeholder="手錠…" style="flex:1;"></div>
          <div class="row"><button id="iconsApply">アイコン適用</button></div>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center;">
        <div class="help">保存先キー: <b>sg_roulette_theme_v010</b>（ブラウザ毎）。容量は概ね 5MB 目安。</div>
        <div>
          <button id="saveTheme">保存</button>
          <button id="exportTheme">エクスポート</button>
          <input id="importThemeFile" type="file" accept="application/json" style="display:none;">
          <button id="importTheme">インポート</button>
          <button id="resetTheme" class="btn-danger">リセット</button>
        </div>
      </div>
    </div>
  </div>

  <!-- アプリ本体 -->
  <div id="app" style="display:none;">
    <div class="toolbar">
      <button id="openSettings">⚙️ UI設定</button>
      <button id="muteToggle">🔇 ミュート</button>
      <div class="volrow" style="min-width:220px;">
        <span>Master</span>
        <input id="volMasterToolbar" type="range" min="0" max="1" step="0.01" style="width:160px;">
        <span id="volMasterToolbarLabel" class="small">100%</span>
      </div>
      <span class="small" style="opacity:0.8;">ver.α0.10 — assets優先読み込み / localStorage上書き / 音量</span>
    </div>
    <h1>ショットガン・ルーレット（デジタル版）</h1>

    <div class="controls">
      <div class="panel">
        <label>プレイヤー数</label>
        <select id="playerCount">
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4" selected>4</option>
        </select>

        <label>初期HP（各プレイヤー）</label>
        <input type="number" id="initHp" value="5" min="1" max="20" />

        <label>薬室（合計発数）</label>
        <input type="number" id="chamberSize" value="6" min="1" max="12" />

        <label>実弾数（薬室内）</label>
        <input type="number" id="liveCount" value="3" min="0" max="12" />

        <div style="margin-top:8px;">
          <button id="startBtn" class="btn-primary">ゲーム開始</button>
          <button id="resetBtn" class="btn-danger">リセット</button>
        </div>
        <div style="margin-top:8px; font-size:13px; color:#bbb;">
          ※ 毎ラウンド開始時に各プレイヤーにランダムでアイテムを3枚配布します。<br>
          ※ 使用可能アイテム：ノコギリ、拡大鏡、ビール、タバコ、手錠
        </div>
      </div>

      <div class="panel">
        <div class="big">現在ラウンド: <span id="roundNo">0</span></div>
        <div class="chamber">残薬室: <span id="chamberRemain">0</span> / <span id="chamberTotal">0</span></div>
        <div>先頭弾の状態: <span id="peekState">不明</span></div>
        <div style="margin-top:8px;">現在ターン: <span id="currentPlayer">-</span></div>
        <div style="margin-top:8px;" class="actions">
          <select id="targetSelect" class="target-select"></select>
          <button id="shootBtn">撃つ</button>
          <button id="shootSelfBtn">自分に撃つ</button>
        </div>
        <div style="margin-top:8px;">
          <button id="endTurnBtn">ターン終了</button>
        </div>
      </div>

      <div class="panel" style="flex:1; min-width:260px;">
        <div style="font-weight:700; margin-bottom:8px;">プレイヤー一覧</div>
        <div id="playersContainer" class="players"></div>
      </div>
    </div>

    <div class="game">
      <div class="panel" style="flex:1;">
        <div style="font-weight:700; margin-bottom:8px;">行動ログ</div>
        <div id="log" class="log"></div>
        <div style="margin-top:8px;">
          <button id="clearLog">ログクリア</button>
        </div>
      </div>

      <div class="panel" style="width:340px;">
        <div style="font-weight:700; margin-bottom:8px;">アイテム操作</div>
        <div id="itemControls">
          <div>自分のアイテムをクリックして使用してください（ターン中のみ）。</div>
          <div style="margin-top:8px;" id="yourItems"></div>
        </div>

        <div style="margin-top:12px;">
          <div style="font-weight:700; margin-bottom:6px;">拡大鏡で覗いた情報</div>
          <div id="peekArea" class="peek-indicator">なし</div>
        </div>
      </div>
    </div>

    <footer>バージョン: α0.10 — 安定版：assets/config.json → localStorage 上書き、音量コントロール、効果音修正、実弾フラッシュ</footer>
  </div>

<!-- Audio elements -->
<audio id="sndBlank" preload="auto"></audio>
<audio id="sndLive" preload="auto"></audio>
<audio id="sndClick" preload="auto"></audio>

<script>
/* ====================== テーマ読み込み（assets → localStorage） ====================== */
const THEME_KEY = "sg_roulette_theme_v010";
const defaultTheme = {
  flashColor: "#ffffff",
  background: null,
  panel: null,
  avatars: { P1:null, P2:null, P3:null, P4:null },
  icons: { "ノコギリ":null, "拡大鏡":null, "ビール":null, "タバコ":null, "手錠":null },
  sounds: { blank:null, live:null, click:null, volume:{ master:1, blank:1, live:1, click:1 }, muted:false }
};
let theme = structuredClone ? structuredClone(defaultTheme) : JSON.parse(JSON.stringify(defaultTheme));

async function loadAssetsThenLocal(){
  try{
    const r = await fetch("assets/config.json", {cache:"no-store"});
    if(r.ok){
      const cfg = await r.json();
      // assets をベースに取り込む
      theme = { ...theme, ...cfg };
      // volume や muted の補完
      theme.sounds = theme.sounds || {};
      theme.sounds.volume = { master:1, blank:1, live:1, click:1, ...(theme.sounds.volume||{}) };
      theme.sounds.muted = !!theme.sounds.muted;
    }
  }catch(e){ console.info("assets/config.json が見つからない/読み込めないためスキップ", e); }

  try{
    const s = localStorage.getItem(THEME_KEY);
    if(s){
      const override = JSON.parse(s);
      // localStorage で全面上書き（特に avatars は常にこちらを優先）
      theme = { ...theme, ...override };
      theme.avatars = { ...((theme.avatars)||{}), ...((override.avatars)||{}) };
      theme.icons   = { ...((theme.icons)||{}),   ...((override.icons)||{}) };
      theme.sounds  = { ...((theme.sounds)||{}),  ...((override.sounds)||{}) };
      theme.sounds.volume = { master:1, blank:1, live:1, click:1, ...(((override.sounds||{}).volume)||((theme.sounds||{}).volume)||{}) };
      theme.sounds.muted = !!((override.sounds||{}).muted ?? theme.sounds.muted);
    }
  }catch(e){ console.warn("localStorage 読み込み失敗", e); }

  applyThemeToDOM();
  renderPlayers();
  syncSoundUI();
}

function saveThemeToStorage(){
  try{
    localStorage.setItem(THEME_KEY, JSON.stringify(theme));
    alert("保存しました。");
  }catch(e){ alert("保存に失敗しました（容量超過の可能性）"); }
}
function resetTheme(){
  if(!confirm("UI設定をリセットしますか？")) return;
  theme = JSON.parse(JSON.stringify(defaultTheme));
  applyThemeToDOM(); renderPlayers(); syncSoundUI();
}
function exportTheme(){
  const blob = new Blob([JSON.stringify(theme,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "sg_roulette_theme_v010.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
function importTheme(file){
  const fr = new FileReader();
  fr.onload = () => {
    try{
      const data = JSON.parse(fr.result);
      theme = { ...defaultTheme, ...(data||{}) };
      applyThemeToDOM(); renderPlayers(); syncSoundUI();
      alert("インポート完了");
    }catch(e){ alert("インポート失敗：JSON形式を確認してください。"); }
  };
  fr.readAsText(file);
}
function applyThemeToDOM(){
  document.documentElement.style.setProperty("--bg-image", theme.background? `url(${theme.background})` : "none");
  document.documentElement.style.setProperty("--panel-image", theme.panel? `url(${theme.panel})` : "none");
  document.documentElement.style.setProperty("--flash-color", theme.flashColor || "#ffffff");
  // サウンドURLの適用
  if(theme.sounds.blank) el("sndBlank").src = theme.sounds.blank;
  if(theme.sounds.live)  el("sndLive").src  = theme.sounds.live;
  if(theme.sounds.click) el("sndClick").src = theme.sounds.click;
  updateAudioVolumes();
}
function updateAudioVolumes(){
  const m = theme.sounds.volume?.master ?? 1;
  const vb = theme.sounds.volume?.blank ?? 1;
  const vl = theme.sounds.volume?.live ?? 1;
  const vc = theme.sounds.volume?.click ?? 1;
  const muted = !!theme.sounds.muted;
  const setVol = (id, v) => {
    const a = el(id);
    a.volume = muted ? 0 : Math.max(0, Math.min(1, v));
  };
  setVol("sndBlank", m * vb);
  setVol("sndLive",  m * vl);
  setVol("sndClick", m * vc);
}

/* ====================== 設定UI・プリセット ====================== */
function fileToDataURL(file, cb){
  const fr = new FileReader();
  fr.onload = () => cb(fr.result);
  fr.readAsDataURL(file);
}
function openSettings(){
  // プレビュー
  el("bgPreview").style.backgroundImage = theme.background? `url(${theme.background})` : "none";
  el("panelPreview").style.backgroundImage = theme.panel? `url(${theme.panel})` : "none";
  el("flashColor").value = theme.flashColor || "#ffffff";

  ["p1Prev","p2Prev","p3Prev","p4Prev"].forEach((id,i)=>{
    const key = "P"+(i+1);
    el(id).style.backgroundImage = theme.avatars[key]? `url(${theme.avatars[key]})` : "none";
    el("p"+(i+1)+"Url").value = theme.avatars[key] || "";
  });

  const map = [["icoSaw","ノコギリ"],["icoGlass","拡大鏡"],["icoBeer","ビール"],["icoSmoke","タバコ"],["icoCuff","手錠"]];
  map.forEach(([id,label])=>{
    el(id+"Prev")?.style && (el(id+"Prev").style.backgroundImage = theme.icons[label]? `url(${theme.icons[label]})` : "none");
    el(id).value = theme.icons[label] || "";
  });

  // サウンドUI
  syncSoundUI();
  el("settingsModal").style.display = "flex";
}
function closeSettings(){ el("settingsModal").style.display = "none"; }

function syncSoundUI(){
  el("sndBlankUrl").value = theme.sounds.blank || "";
  el("sndLiveUrl").value  = theme.sounds.live  || "";
  el("sndClickUrl").value = theme.sounds.click || "";
  el("volMaster").value = theme.sounds.volume.master ?? 1;
  el("volBlank").value  = theme.sounds.volume.blank ?? 1;
  el("volLive").value   = theme.sounds.volume.live  ?? 1;
  el("volClick").value  = theme.sounds.volume.click ?? 1;
  el("volMasterLabel").textContent = Math.round((theme.sounds.volume.master ?? 1)*100) + "%";
  el("volBlankLabel").textContent  = Math.round((theme.sounds.volume.blank ?? 1)*100) + "%";
  el("volLiveLabel").textContent   = Math.round((theme.sounds.volume.live  ?? 1)*100) + "%";
  el("volClickLabel").textContent  = Math.round((theme.sounds.volume.click ?? 1)*100) + "%";
  el("volMasterToolbar").value = theme.sounds.volume.master ?? 1;
  el("volMasterToolbarLabel").textContent = Math.round((theme.sounds.volume.master ?? 1)*100) + "%";
}

/* ====================== コアゲーム（α0.3相当の安定化） ====================== */
const ITEMS = ["ノコギリ","拡大鏡","ビール","タバコ","手錠"];

let state = {
  players: [], playerCount: 4, initHp: 5,
  chamber: [], chamberTotal: 0, round: 0,
  currentIndex: 0, peekInfo: null,
  autoNextOnEmptySelfShot: true
};

const el = id => document.getElementById(id);

function log(msg){
  const l = el("log");
  const time = new Date().toLocaleTimeString();
  l.innerHTML = `<div>[${time}] ${escapeHtml(msg)}</div>` + l.innerHTML;
}
function escapeHtml(s){ return s==null? "" : s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

function flash(){
  const f = el("flashOverlay");
  f.style.animation = "flashEffect 0.28s ease";
  f.onanimationend = () => { f.style.animation = ""; };
}

function initUI(){
  el("startBtn").onclick = startGame;
  el("resetBtn").onclick = resetAll;
  el("shootBtn").onclick = () => performShoot(false);
  el("shootSelfBtn").onclick = () => performShoot(true);
  el("endTurnBtn").onclick = endTurn;
  el("clearLog").onclick = () => el("log").innerHTML = "";

  // タイトル → ゲームへ
  const title = el("titleScreen");
  const app = el("app");
  el("startBtnTitle").addEventListener("click", () => {
    // 初回クリックで効果音の自動再生制限を解除（クリック音を一回鳴らす）
    playSound('click');
    title.style.display = "none";
    app.style.display = "block";
    startGame();
  });

  // 設定モーダルイベント
  el("openSettings").onclick = ()=>{ playSound('click'); openSettings(); };
  el("closeSettings").onclick = closeSettings;
  el("settingsBackdrop").onclick = closeSettings;

  el("bgApply").onclick = () => {
    const url = (el("bgUrl").value || "").trim();
    theme.background = url || null; applyThemeToDOM();
    el("bgPreview").style.backgroundImage = url? `url(${url})` : "none";
  };
  el("panelApply").onclick = () => {
    const url = (el("panelUrl").value || "").trim();
    theme.panel = url || null; applyThemeToDOM();
    el("panelPreview").style.backgroundImage = url? `url(${url})` : "none";
  };
  el("flashTest").onclick = () => { flash(); };

  el("avatarsApply").onclick = () => {
    for(let i=1;i<=4;i++){
      const key = "P"+i;
      const url = (el("p"+i+"Url").value || "").trim();
      theme.avatars[key] = url || null;
    }
    renderPlayers();
  };
  el("iconsApply").onclick = () => {
    const map = [["icoSaw","ノコギリ"],["icoGlass","拡大鏡"],["icoBeer","ビール"],["icoSmoke","タバコ"],["icoCuff","手錠"]];
    map.forEach(([id,label]) => {
      const url = (el(id).value || "").trim();
      theme.icons[label] = url || null;
    });
    renderPlayers();
  };

  el("soundsApply").onclick = () => {
    theme.sounds.blank = (el("sndBlankUrl").value || "").trim() || null;
    theme.sounds.live  = (el("sndLiveUrl").value  || "").trim() || null;
    theme.sounds.click = (el("sndClickUrl").value || "").trim() || null;
    theme.sounds.volume.master = parseFloat(el("volMaster").value);
    theme.sounds.volume.blank  = parseFloat(el("volBlank").value);
    theme.sounds.volume.live   = parseFloat(el("volLive").value);
    theme.sounds.volume.click  = parseFloat(el("volClick").value);
    applyThemeToDOM();
  };
  el("testBlank").onclick = () => playSound('blank');
  el("testLive").onclick  = () => playSound('live');
  el("testClick").onclick = () => playSound('click');

  // ツールバーのマスター音量スライダー・ミュート
  el("volMasterToolbar").addEventListener("input", ()=>{
    theme.sounds.volume.master = parseFloat(el("volMasterToolbar").value);
    el("volMasterToolbarLabel").textContent = Math.round(theme.sounds.volume.master*100)+"%";
    updateAudioVolumes();
  });
  el("muteToggle").onclick = ()=>{
    theme.sounds.muted = !theme.sounds.muted;
    el("muteToggle").textContent = theme.sounds.muted ? "🔈 ミュート解除" : "🔇 ミュート";
    updateAudioVolumes();
  };

  el("saveTheme").onclick = () => { theme.flashColor = el("flashColor").value || "#ffffff"; applyThemeToDOM(); saveThemeToStorage(); };
  el("resetTheme").onclick = () => { resetTheme(); saveThemeToStorage(); };
  el("exportTheme").onclick = exportTheme;
  el("importTheme").onclick = () => el("importThemeFile").click();
  el("importThemeFile").onchange = (e) => { const f = e.target.files[0]; if(f) importTheme(f); };
}

function resetAll(){
  state = {
    players: [],
    playerCount: parseInt(el("playerCount").value),
    initHp: parseInt(el("initHp").value),
    chamber: [], chamberTotal: 0, round: 0,
    currentIndex: 0, peekInfo: null, autoNextOnEmptySelfShot: true
  };
  updateUI();
  el("playersContainer").innerHTML = "";
  el("yourItems").innerHTML = "";
  el("peekArea").innerText = "なし";
  log("ゲームをリセットしました。");
}
function startGame(){
  resetAll();
  state.playerCount = parseInt(el("playerCount").value);
  state.initHp = parseInt(el("initHp").value);
  let chamberSize = parseInt(el("chamberSize").value);
  let liveCount = parseInt(el("liveCount").value);
  if(!Number.isFinite(chamberSize) || chamberSize <= 0) chamberSize = 1;
  if(!Number.isFinite(liveCount) || liveCount < 0) liveCount = 0;
  if(liveCount > chamberSize){ liveCount = chamberSize; }

  state.players = [];
  for(let i=0;i<state.playerCount;i++){
    state.players.push({
      id: i, name: `P${i+1}`, hp: state.initHp, alive: true, items: [],
      skip: false, hasSawBuff: false
    });
  }
  state.round = 1;
  buildChamber(chamberSize, liveCount);
  distributeItemsToAll();
  state.currentIndex = 0; state.peekInfo = null;
  updateUI();
  log(`ゲーム開始。プレイヤー数=${state.playerCount}, 薬室=${chamberSize}, 実弾=${liveCount}`);
  announceTurn();
}
function buildChamber(size, liveCount){
  // Sanitize & clamp
  let s = parseInt(size); let l = parseInt(liveCount);
  if(!Number.isFinite(s) || s <= 0) s = 1;
  if(!Number.isFinite(l) || l < 0) l = 0;
  if(l > s) l = s;
  const arr = [];
  for(let i=0;i<l;i++) arr.push("live");
  for(let i=0;i<s-l;i++) arr.push("blank");
  shuffle(arr);
  state.chamber = arr;
  state.chamberTotal = s;
  el("chamberTotal").innerText = s;
  el("chamberRemain").innerText = state.chamber.length;
}
function distributeItemsToAll(){
  for(const p of state.players){
    if(!p.alive) continue;
    p.items = [];
    for(let i=0;i<3;i++){ p.items.push(randomOf(ITEMS)); }
  }
  renderPlayers();
  log(`ラウンド ${state.round} 開始。各プレイヤーにランダムで3つのアイテムを配布しました。`);
}
function shuffle(a){ for(let i=a.length-1;i>0;i++){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function randomOf(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function renderPlayers(){
  const cont = el("playersContainer"); if(!cont) return;
  cont.innerHTML = "";
  for(let i=0;i<state.players.length;i++){
    const p = state.players[i];
    const div = document.createElement("div");
    div.className = "player" + (p.alive? "":" dead");
    div.id = "player_"+p.id;
    const itemsHtml = p.items.map((it, idx)=>{
      const iconUrl = theme.icons[it];
      const iconHtml = iconUrl ? `<span class="icon" style="background-image:url('${iconUrl}')"></span>` : "";
      return `<span class="item" data-player="${p.id}" data-idx="${idx}">${iconHtml}<span>${it}</span></span>`;
    }).join("");

    // アバターは LS を最優先
    const avatarUrl = theme.avatars["P"+(i+1)] || (theme.assetsAvatars? theme.assetsAvatars["P"+(i+1)] : null);
    const avatarStyle = avatarUrl? `background-image:url('${avatarUrl}')` : "";

    div.innerHTML = `
      <div class="avatar" style="${avatarStyle}"></div>
      <div>
        <div style="font-weight:700">${p.name} ${state.currentIndex===i? "←":""}</div>
        <div>HP: <span class="hp">${p.hp}</span></div>
        <div>状態: ${p.alive? "生存":"脱落"}</div>
        <div class="items">アイテム: ${itemsHtml}</div>
        <div style="margin-top:6px; font-size:13px;">${p.skip? "（次ターンをスキップ予定）": ""}</div>
      </div>
    `;
    cont.appendChild(div);
  }
  document.querySelectorAll('.item').forEach(elm=>{
    elm.onclick = (e) => {
      const pid = parseInt(elm.getAttribute('data-player'));
      const idx = parseInt(elm.getAttribute('data-idx'));
      if(pid !== state.currentIndex){ alert("自分のターンの時だけアイテムを使用できます。"); return; }
      useItem(pid, idx);
    };
  });
  updateYourItems();
}
function updateYourItems(){
  const p = state.players[state.currentIndex];
  if(!p){ el("yourItems").innerHTML = "なし"; return; }
  const area = el("yourItems");
  area.innerHTML = p.items.map((it, idx)=>{
    const iconUrl = theme.icons[it];
    const iconHtml = iconUrl ? `<span class="icon" style="width:16px;height:16px; background-image:url('${iconUrl}'); display:inline-block; vertical-align:-3px; margin-right:6px;"></span>` : "";
    return `<button data-idx="${idx}" data-player="${p.id}">${iconHtml}${it}</button>`;
  }).join(" ");
  area.querySelectorAll('button').forEach(btn=>{
    btn.onclick = () => {
      const idx = parseInt(btn.getAttribute('data-idx'));
      if(state.currentIndex !== parseInt(btn.getAttribute('data-player'))){ alert("自分のターンの時だけ使用可能"); return; }
      useItem(state.currentIndex, idx);
    };
  });
}

function updateUI(){
  el("roundNo").innerText = state.round;
  el("chamberRemain").innerText = state.chamber.length;
  el("chamberTotal").innerText = state.chamberTotal;
  el("currentPlayer").innerText = state.players[state.currentIndex]? state.players[state.currentIndex].name : "-";
  el("peekState").innerText = state.peekInfo ? (state.peekInfo==="live"? "実弾":"空包") : "不明";
  renderPlayers();
  populateTargetSelect();
}
function populateTargetSelect(){
  const sel = el("targetSelect"); sel.innerHTML = "";
  const cur = state.players[state.currentIndex]; if(!cur) return;
  for(const p of state.players){
    if(!p.alive) continue;
    const opt = document.createElement("option");
    opt.value = p.id; opt.text = p.name + (p.id===cur.id? " (自分)":"");
    sel.add(opt);
  }
  let defaultIndex = 0;
  for(let i=0;i<sel.options.length;i++){
    if(parseInt(sel.options[i].value) !== cur.id){ defaultIndex = i; break; }
  }
  sel.selectedIndex = defaultIndex;
}

function announceTurn(){
  if(allDeadOrOneLeft()) return;
  while(state.players[state.currentIndex] && !state.players[state.currentIndex].alive){
    state.currentIndex = (state.currentIndex+1)%state.players.length;
  }
  const cur = state.players[state.currentIndex];
  if(!cur) return;
  if(cur.skip){
    log(`${cur.name} のターンは手錠効果でスキップされました。`);
    cur.skip = false; advanceTurn(); return;
  }
  updateUI();
  log(`ターン: ${cur.name}`);
}

function performShoot(isSelf){
  const cur = state.players[state.currentIndex];
  if(!cur || !cur.alive){ log("行動できるプレイヤーがいません。"); return; }
  if(state.chamber.length === 0){
    log("薬室が空です。ラウンド終了処理を行います。");
    endRound(); return;
  }
  const targetId = isSelf ? cur.id : parseInt(el("targetSelect").value);
  const target = state.players.find(p=>p.id===targetId);
  if(!target || !target.alive){ alert("無効なターゲットです。"); return; }

  const top = state.chamber.shift();
  state.peekInfo = null;
  el("peekArea").innerText = "なし";
  el("chamberRemain").innerText = state.chamber.length;

  if(top === "blank"){
    playSound('blank');
    log(`${cur.name} が ${target.name} に発砲 → 空包（安心）。`);
    if(isSelf){
      log(`${cur.name} は空包だったため、追加で行動できます。`);
      updateUI(); checkRoundEndAfterShot(); return;
    } else {
      checkRoundEndAfterShot(); advanceTurn(); return;
    }
  } else {
    playSound('live');
    flash();
    let dmg = 1;
    if(cur.hasSawBuff){
      dmg = 2; cur.hasSawBuff = false;
      log(`${cur.name} のノコギリ効果でダメージが2倍になった！`);
    }
    target.hp -= dmg;
    log(`${cur.name} が ${target.name} に発砲 → 実弾！ ${target.name} に ${dmg} ダメージ。残HP=${Math.max(0,target.hp)}`);
    if(target.hp <= 0){ target.alive = false; log(`${target.name} は脱落しました。`); }
    checkRoundEndAfterShot(); advanceTurn(); return;
  }
}
function checkRoundEndAfterShot(){
  if(state.chamber.length === 0){
    log("このラウンドの薬室は全て撃たれました。ラウンド終了です。");
    endRound();
  } else { updateUI(); }
}
function endTurn(){ advanceTurn(); }
function advanceTurn(){
  if(allDeadOrOneLeft()) return;
  let next = state.currentIndex;
  for(let i=1;i<=state.players.length;i++){
    const cand = (state.currentIndex + i) % state.players.length;
    if(state.players[cand].alive){ next = cand; break; }
  }
  state.currentIndex = next; announceTurn();
}
function allDeadOrOneLeft(){
  const alive = state.players.filter(p=>p.alive);
  if(alive.length <= 1){
    if(alive.length === 1){ log(`ゲーム終了！ 勝者: ${alive[0].name}`); }
    else { log("すべてのプレイヤーが脱落しました（同時脱落）。"); }
    updateUI(); return true;
  }
  return false;
}
function endRound(){
  const alive = state.players.filter(p=>p.alive);
  if(alive.length <= 1){ allDeadOrOneLeft(); return; }
  state.round += 1;
  const chamberSize = parseInt(el("chamberSize").value);
  const liveCount = parseInt(el("liveCount").value);
  buildChamber(chamberSize, liveCount);
  distributeItemsToAll();
  state.currentIndex = state.players.findIndex(p=>p.alive);
  announceTurn();
}

function useItem(pid, idx){
  const p = state.players[pid];
  if(!p || !p.alive){ alert("使用不可"); return; }
  if(pid !== state.currentIndex){ alert("自分のターンの時だけ使えます"); return; }
  const item = p.items[idx];
  if(!item){ alert("アイテムがありません"); return; }

  switch(item){
    case "ノコギリ": p.hasSawBuff = true; log(`${p.name} は ノコギリ を使用。次に命中すればダメージ2倍。`); break;
    case "拡大鏡":
      if(state.chamber.length === 0){ log("薬室が空のため覗けません。"); }
      else {
        const next = state.chamber[0]; state.peekInfo = next;
        el("peekArea").innerText = (next==="live"?"実弾":"空包");
        log(`${p.name} は 拡大鏡 を使い、先頭弾が「${next==="live"?"実弾":"空包"}」であることを確認した。`);
      }
      break;
    case "ビール":
      if(state.chamber.length===0){ log("薬室に弾がないため排莢できません。"); }
      else {
        const removed = state.chamber.shift();
        log(`${p.name} は ビール を使用し、次の弾を排莢した（${removed==="live"?"実弾が取り除かれた":"空包が取り除かれた"}）。`);
        el("chamberRemain").innerText = state.chamber.length;
      }
      break;
    case "タバコ": p.hp += 1; log(`${p.name} は タバコ を喫み、HPを1回復。（現在HP=${p.hp}）`); break;
    case "手錠":
      let nextOpp = null;
      for(let i=1;i<state.players.length;i++){
        const cand = (state.currentIndex + i) % state.players.length;
        if(state.players[cand].alive){ nextOpp = state.players[cand]; break; }
      }
      if(nextOpp){ nextOpp.skip = true; log(`${p.name} は 手錠 を使用。次のプレイヤー ${nextOpp.name} のターンを飛ばす。`); }
      else { log("スキップ対象が見つからないため手錠は効果がなかった。"); }
      break;
    default: log("未定義のアイテム");
  }

  p.items.splice(idx,1);
  renderPlayers(); updateYourItems(); updateUI();
  log(`（${p.name} のターン継続：アイテム使用はターンを消費しません）`);
}

/* ====================== サウンド管理 ====================== */
function playSound(name){
  const id = {blank:"sndBlank", live:"sndLive", click:"sndClick"}[name];
  if(!id) return;
  const a = el(id);
  if(a && a.src){ try{ a.currentTime = 0; a.play().catch(()=>{}); }catch(_e){} }
}

document.addEventListener("DOMContentLoaded", () => {
  // 初期ロード
  loadAssetsThenLocal().then(()=>{
    initUI();
  });
});
</script>

</body>
</html>
