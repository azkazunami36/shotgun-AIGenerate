<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‚·ãƒ§ãƒƒãƒˆã‚¬ãƒ³ãƒ»ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆãƒ‡ã‚¸ã‚¿ãƒ«ç‰ˆ ver.Î±0.10 / solid buildï¼‰</title>
<style>
  :root{
    --bg:#111; --panel:#1b1b1b; --sub:#141414; --text:#eee; --muted:#bbb;
    --chip:#222; --accent:#1b5b3b; --danger:#5b1b1b;
    --bg-image:none; --panel-image:none; --flash-color:#ffffff;
  }
  *{box-sizing:border-box;}
  body{
    font-family: "Yu Gothic UI", "Hiragino Kaku Gothic ProN", "Meiryo", system-ui, sans-serif;
    background:var(--bg);
    background-image: var(--bg-image);
    background-size:cover; background-position:center; background-attachment:fixed;
    color:var(--text); padding:16px; margin:0;
  }
  h1{margin:0 0 12px 0; font-size:20px;}
  .controls, .game {display:flex; gap:16px; margin-bottom:12px; flex-wrap:wrap;}
  .panel{
    background:var(--panel);
    background-image: var(--panel-image);
    background-size:cover; background-position:center;
    padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.6); min-width:220px;
  }
  label{display:block; margin-bottom:6px; font-size:13px; color:#ccc;}
  input, select, button{padding:6px 8px; border-radius:6px; border:1px solid #333; background:#121212; color:var(--text);}
  button{cursor:pointer;}
  .players{display:flex; gap:12px; flex-wrap:wrap;}
  .player{padding:8px; border-radius:6px; background:var(--sub); min-width:200px; display:grid; grid-template-columns:48px 1fr; grid-gap:8px; align-items:center;}
  .player.dead{opacity:0.35; text-decoration:line-through;}
  .avatar{width:48px; height:48px; border-radius:6px; background:#000 center/cover no-repeat;}
  .hp{font-weight:700; color:#ffb3b3;}
  .items{margin-top:8px;}
  .item{display:inline-flex; align-items:center; gap:6px; padding:4px 6px; margin:4px 4px 0 0; background:var(--chip); border-radius:6px; font-size:13px;}
  .item .icon{width:16px; height:16px; background:center/cover no-repeat;}
  .log{height:240px; overflow:auto; background:#0f0f0f; padding:8px; border-radius:6px; font-size:13px;}
  .chamber{font-size:13px; color:#ccc; margin-top:8px;}
  .big{font-size:16px;}
  .actions{margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;}
  .target-select{width:100%;}
  .peek-indicator{font-weight:700; color:#ffd27f;}
  footer{margin-top:12px; font-size:12px; color:#888;}
  .btn-danger{background:var(--danger);}
  .btn-primary{background:var(--accent);}
  .toolbar{display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;}

  /* ã‚¿ã‚¤ãƒˆãƒ« */
  #titleScreen{
    position:fixed; inset:0; z-index:1000;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:radial-gradient(1200px 800px at 50% 40%, #222 0%, #000 70%);
    color:#f5f5f5; text-align:center;
  }
  #titleScreen h1{font-size:40px; letter-spacing:1px; margin:0;}
  #titleScreen p{margin:8px 0 0 0; color:#d0d0d0;}
  #startBtnTitle{margin-top:24px; padding:12px 24px; font-size:18px; border:1px solid #333; background:#162b22;}

  /* ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
  #flashOverlay{ position:fixed; inset:0; background:var(--flash-color); opacity:0; pointer-events:none; z-index:999; }
  @keyframes flashEffect{ 0%{opacity:0;} 15%{opacity:1;} 100%{opacity:0;} }

  /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
  #settingsModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1100; }
  #settingsBackdrop{position:absolute; inset:0; background:rgba(0,0,0,0.6);}
  #settingsPanel{position:relative; background:#1a1a1a; border:1px solid #333; border-radius:10px; padding:16px; width:min(980px,94vw); max-height:90vh; overflow:auto; box-shadow:0 10px 40px rgba(0,0,0,0.8);}
  #settingsPanel h2{margin:0 0 8px 0; font-size:18px;}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .preview{width:100%; height:120px; background:#000 center/cover no-repeat; border-radius:6px; border:1px solid #333;}
  .help{font-size:12px; color:#aaa;}
  .small{font-size:12px;}
  .icon-preview{width:24px; height:24px; background:#000 center/cover no-repeat; border-radius:4px; border:1px solid #333; display:inline-block; vertical-align:middle;}

  /* éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
  .volrow{display:flex; align-items:center; gap:8px;}
  .volrow input[type=range]{flex:1;}
</style>
</head>
<body>

  <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
  <div id="titleScreen">
    <h1>ã‚·ãƒ§ãƒƒãƒˆã‚¬ãƒ³ãƒ»ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h1>
    <p>digital edition â€” ver.Î±0.10ï¼ˆassets + localStorage + volumeï¼‰</p>
    <button id="startBtnTitle">START</button>
    <div class="small" style="margin-top:6px;">â€»æœ€åˆã®ã‚¯ãƒªãƒƒã‚¯ã§ã‚µã‚¦ãƒ³ãƒ‰ã‚’æœ‰åŠ¹åŒ–</div>
  </div>

  <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ¼”å‡º -->
  <div id="flashOverlay"></div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆassetsã‚’åŸºæº–ã€localStorageã§ä¸Šæ›¸ãï¼‰ -->
  <div id="settingsModal">
    <div id="settingsBackdrop"></div>
    <div id="settingsPanel">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <h2>UIç”»åƒãƒ»ãƒ†ãƒ¼ãƒè¨­å®šï¼ˆassets â†’ localStorage ä¸Šæ›¸ãï¼‰</h2>
        <div>
          <button id="presetDefault" class="small">ãƒ—ãƒªã‚»ãƒƒãƒˆ: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</button>
          <button id="presetWood" class="small">ãƒ—ãƒªã‚»ãƒƒãƒˆ: æœ¨ç›®</button>
          <button id="closeSettings" class="small">é–‰ã˜ã‚‹</button>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <h3 style="margin:0 0 8px 0;">ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š</h3>
          <div class="row small">å¼¾ç™ºå°„ã‚„ã‚¯ãƒªãƒƒã‚¯éŸ³ã®éŸ³æºURLï¼ˆassetsè¨­å®š or data URL ã‚‚å¯ï¼‰ã€‚</div>
          <div class="row">
            <label style="width:60px;">ç©ºåŒ…</label><input id="sndBlankUrl" type="url" placeholder="ç©ºåŒ…éŸ³â€¦" style="flex:1;">
          </div>
          <div class="row">
            <label style="width:60px;">å®Ÿå¼¾</label><input id="sndLiveUrl" type="url" placeholder="å®Ÿå¼¾éŸ³â€¦" style="flex:1;">
          </div>
          <div class="row">
            <label style="width:60px;">ã‚¯ãƒªãƒƒã‚¯</label><input id="sndClickUrl" type="url" placeholder="ã‚¯ãƒªãƒƒã‚¯éŸ³â€¦" style="flex:1;">
          </div>
          <div class="row volrow">
            <span>Master</span><input id="volMaster" type="range" min="0" max="1" step="0.01"><span id="volMasterLabel" class="small">100%</span>
          </div>
          <div class="row volrow">
            <span>ç©ºåŒ…</span><input id="volBlank" type="range" min="0" max="1" step="0.01"><span id="volBlankLabel" class="small">100%</span>
          </div>
          <div class="row volrow">
            <span>å®Ÿå¼¾</span><input id="volLive" type="range" min="0" max="1" step="0.01"><span id="volLiveLabel" class="small">100%</span>
          </div>
          <div class="row volrow">
            <span>ã‚¯ãƒªãƒƒã‚¯</span><input id="volClick" type="range" min="0" max="1" step="0.01"><span id="volClickLabel" class="small">100%</span>
          </div>
          <div class="row"><button id="soundsApply">ã‚µã‚¦ãƒ³ãƒ‰é©ç”¨</button> <button id="testBlank">ç©ºåŒ…ãƒ†ã‚¹ãƒˆ</button> <button id="testLive">å®Ÿå¼¾ãƒ†ã‚¹ãƒˆ</button> <button id="testClick">ã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</button></div>
          <div class="small">â€»å†ç”Ÿã•ã‚Œãªã„å ´åˆã¯ã€ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã® START ã‚’æŠ¼ã—ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ï¼ˆè‡ªå‹•å†ç”Ÿåˆ¶é™ï¼‰ã€‚</div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 8px 0;">èƒŒæ™¯ç”»åƒ</h3>
          <div class="row">
            <input id="bgUrl" type="url" placeholder="ç”»åƒURL / data URLâ€¦" style="flex:1;">
            <button id="bgApply">é©ç”¨</button>
          </div>
          <div class="preview" id="bgPreview"></div>
          <div class="help">ãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒã¯ data URL ã§è²¼ã‚Šä»˜ã‘å¯ï¼ˆlocalStorageä¸Šé™ã«æ³¨æ„ï¼‰ã€‚</div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 8px 0;">ãƒ‘ãƒãƒ«èƒŒæ™¯</h3>
          <div class="row">
            <input id="panelUrl" type="url" placeholder="ç”»åƒURL / data URLâ€¦" style="flex:1;">
            <button id="panelApply">é©ç”¨</button>
          </div>
          <div class="preview" id="panelPreview"></div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 8px 0;">ãƒ•ãƒ©ãƒƒã‚·ãƒ¥è‰²</h3>
          <div class="row">
            <input id="flashColor" type="color" value="#ffffff">
            <button id="flashTest">ãƒ†ã‚¹ãƒˆ</button>
          </div>
          <div class="help">å®Ÿå¼¾æ™‚ã«ç”»é¢ãŒç‚¹æ»…ã™ã‚‹è‰²ã€‚</div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 8px 0;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ãƒã‚¿ãƒ¼</h3>
          <div class="row small">P1ã€œP4ã®URL / data URL ã‚’ä¿å­˜ã€‚<b>localStorage ãŒ assets ã‚ˆã‚Šå¸¸ã«å„ªå…ˆ</b>ã€‚</div>
          <div class="row"><span class="icon-preview" id="p1Prev"></span><input id="p1Url" type="url" placeholder="P1ç”»åƒâ€¦" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="p2Prev"></span><input id="p2Url" type="url" placeholder="P2ç”»åƒâ€¦" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="p3Prev"></span><input id="p3Url" type="url" placeholder="P3ç”»åƒâ€¦" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="p4Prev"></span><input id="p4Url" type="url" placeholder="P4ç”»åƒâ€¦" style="flex:1;"></div>
          <div class="row"><button id="avatarsApply">ã‚¢ãƒã‚¿ãƒ¼é©ç”¨</button></div>
        </div>

        <div class="panel">
          <h3 style="margin:0 0 8px 0;">ã‚¢ã‚¤ãƒ†ãƒ ã‚¢ã‚¤ã‚³ãƒ³</h3>
          <div class="row small">å„ã‚¢ã‚¤ãƒ†ãƒ åã«å¯¾å¿œã™ã‚‹ç”»åƒURL / data URLã€‚</div>
          <div class="row"><span class="icon-preview" id="icoSawPrev"></span><input id="icoSaw" type="url" placeholder="ãƒã‚³ã‚®ãƒªâ€¦" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="icoGlassPrev"></span><input id="icoGlass" type="url" placeholder="æ‹¡å¤§é¡â€¦" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="icoBeerPrev"></span><input id="icoBeer" type="url" placeholder="ãƒ“ãƒ¼ãƒ«â€¦" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="icoSmokePrev"></span><input id="icoSmoke" type="url" placeholder="ã‚¿ãƒã‚³â€¦" style="flex:1;"></div>
          <div class="row"><span class="icon-preview" id="icoCuffPrev"></span><input id="icoCuff" type="url" placeholder="æ‰‹éŒ â€¦" style="flex:1;"></div>
          <div class="row"><button id="iconsApply">ã‚¢ã‚¤ã‚³ãƒ³é©ç”¨</button></div>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center;">
        <div class="help">ä¿å­˜å…ˆã‚­ãƒ¼: <b>sg_roulette_theme_v010</b>ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¯ï¼‰ã€‚å®¹é‡ã¯æ¦‚ã­ 5MB ç›®å®‰ã€‚</div>
        <div>
          <button id="saveTheme">ä¿å­˜</button>
          <button id="exportTheme">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <input id="importThemeFile" type="file" accept="application/json" style="display:none;">
          <button id="importTheme">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <button id="resetTheme" class="btn-danger">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
  <div id="app" style="display:none;">
    <div class="toolbar">
      <button id="openSettings">âš™ï¸ UIè¨­å®š</button>
      <button id="muteToggle">ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
      <div class="volrow" style="min-width:220px;">
        <span>Master</span>
        <input id="volMasterToolbar" type="range" min="0" max="1" step="0.01" style="width:160px;">
        <span id="volMasterToolbarLabel" class="small">100%</span>
      </div>
      <span class="small" style="opacity:0.8;">ver.Î±0.10 â€” assetså„ªå…ˆèª­ã¿è¾¼ã¿ / localStorageä¸Šæ›¸ã / éŸ³é‡</span>
    </div>
    <h1>ã‚·ãƒ§ãƒƒãƒˆã‚¬ãƒ³ãƒ»ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆãƒ‡ã‚¸ã‚¿ãƒ«ç‰ˆï¼‰</h1>

    <div class="controls">
      <div class="panel">
        <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°</label>
        <select id="playerCount">
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4" selected>4</option>
        </select>

        <label>åˆæœŸHPï¼ˆå„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰</label>
        <input type="number" id="initHp" value="5" min="1" max="20" />

        <label>è–¬å®¤ï¼ˆåˆè¨ˆç™ºæ•°ï¼‰</label>
        <input type="number" id="chamberSize" value="6" min="1" max="12" />

        <label>å®Ÿå¼¾æ•°ï¼ˆè–¬å®¤å†…ï¼‰</label>
        <input type="number" id="liveCount" value="3" min="0" max="12" />

        <div style="margin-top:8px;">
          <button id="startBtn" class="btn-primary">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
          <button id="resetBtn" class="btn-danger">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div style="margin-top:8px; font-size:13px; color:#bbb;">
          â€» æ¯ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹æ™‚ã«å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ãƒ©ãƒ³ãƒ€ãƒ ã§ã‚¢ã‚¤ãƒ†ãƒ ã‚’3æšé…å¸ƒã—ã¾ã™ã€‚<br>
          â€» ä½¿ç”¨å¯èƒ½ã‚¢ã‚¤ãƒ†ãƒ ï¼šãƒã‚³ã‚®ãƒªã€æ‹¡å¤§é¡ã€ãƒ“ãƒ¼ãƒ«ã€ã‚¿ãƒã‚³ã€æ‰‹éŒ 
        </div>
      </div>

      <div class="panel">
        <div class="big">ç¾åœ¨ãƒ©ã‚¦ãƒ³ãƒ‰: <span id="roundNo">0</span></div>
        <div class="chamber">æ®‹è–¬å®¤: <span id="chamberRemain">0</span> / <span id="chamberTotal">0</span></div>
        <div>å…ˆé ­å¼¾ã®çŠ¶æ…‹: <span id="peekState">ä¸æ˜</span></div>
        <div style="margin-top:8px;">ç¾åœ¨ã‚¿ãƒ¼ãƒ³: <span id="currentPlayer">-</span></div>
        <div style="margin-top:8px;" class="actions">
          <select id="targetSelect" class="target-select"></select>
          <button id="shootBtn">æ’ƒã¤</button>
          <button id="shootSelfBtn">è‡ªåˆ†ã«æ’ƒã¤</button>
        </div>
        <div style="margin-top:8px;">
          <button id="endTurnBtn">ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>
        </div>
      </div>

      <div class="panel" style="flex:1; min-width:260px;">
        <div style="font-weight:700; margin-bottom:8px;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§</div>
        <div id="playersContainer" class="players"></div>
      </div>
    </div>

    <div class="game">
      <div class="panel" style="flex:1;">
        <div style="font-weight:700; margin-bottom:8px;">è¡Œå‹•ãƒ­ã‚°</div>
        <div id="log" class="log"></div>
        <div style="margin-top:8px;">
          <button id="clearLog">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
      </div>

      <div class="panel" style="width:340px;">
        <div style="font-weight:700; margin-bottom:8px;">ã‚¢ã‚¤ãƒ†ãƒ æ“ä½œ</div>
        <div id="itemControls">
          <div>è‡ªåˆ†ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼ˆã‚¿ãƒ¼ãƒ³ä¸­ã®ã¿ï¼‰ã€‚</div>
          <div style="margin-top:8px;" id="yourItems"></div>
        </div>

        <div style="margin-top:12px;">
          <div style="font-weight:700; margin-bottom:6px;">æ‹¡å¤§é¡ã§è¦—ã„ãŸæƒ…å ±</div>
          <div id="peekArea" class="peek-indicator">ãªã—</div>
        </div>
      </div>
    </div>

    <footer>ãƒãƒ¼ã‚¸ãƒ§ãƒ³: Î±0.10 â€” å®‰å®šç‰ˆï¼šassets/config.json â†’ localStorage ä¸Šæ›¸ãã€éŸ³é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã€åŠ¹æœéŸ³ä¿®æ­£ã€å®Ÿå¼¾ãƒ•ãƒ©ãƒƒã‚·ãƒ¥</footer>
  </div>

<!-- Audio elements -->
<audio id="sndBlank" preload="auto"></audio>
<audio id="sndLive" preload="auto"></audio>
<audio id="sndClick" preload="auto"></audio>

<script>
/* ====================== ãƒ†ãƒ¼ãƒèª­ã¿è¾¼ã¿ï¼ˆassets â†’ localStorageï¼‰ ====================== */
const THEME_KEY = "sg_roulette_theme_v010";
const defaultTheme = {
  flashColor: "#ffffff",
  background: null,
  panel: null,
  avatars: { P1:null, P2:null, P3:null, P4:null },
  icons: { "ãƒã‚³ã‚®ãƒª":null, "æ‹¡å¤§é¡":null, "ãƒ“ãƒ¼ãƒ«":null, "ã‚¿ãƒã‚³":null, "æ‰‹éŒ ":null },
  sounds: { blank:null, live:null, click:null, volume:{ master:1, blank:1, live:1, click:1 }, muted:false }
};
let theme = structuredClone ? structuredClone(defaultTheme) : JSON.parse(JSON.stringify(defaultTheme));

async function loadAssetsThenLocal(){
  try{
    const r = await fetch("assets/config.json", {cache:"no-store"});
    if(r.ok){
      const cfg = await r.json();
      // assets ã‚’ãƒ™ãƒ¼ã‚¹ã«å–ã‚Šè¾¼ã‚€
      theme = { ...theme, ...cfg };
      // volume ã‚„ muted ã®è£œå®Œ
      theme.sounds = theme.sounds || {};
      theme.sounds.volume = { master:1, blank:1, live:1, click:1, ...(theme.sounds.volume||{}) };
      theme.sounds.muted = !!theme.sounds.muted;
    }
  }catch(e){ console.info("assets/config.json ãŒè¦‹ã¤ã‹ã‚‰ãªã„/èª­ã¿è¾¼ã‚ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—", e); }

  try{
    const s = localStorage.getItem(THEME_KEY);
    if(s){
      const override = JSON.parse(s);
      // localStorage ã§å…¨é¢ä¸Šæ›¸ãï¼ˆç‰¹ã« avatars ã¯å¸¸ã«ã“ã¡ã‚‰ã‚’å„ªå…ˆï¼‰
      theme = { ...theme, ...override };
      theme.avatars = { ...((theme.avatars)||{}), ...((override.avatars)||{}) };
      theme.icons   = { ...((theme.icons)||{}),   ...((override.icons)||{}) };
      theme.sounds  = { ...((theme.sounds)||{}),  ...((override.sounds)||{}) };
      theme.sounds.volume = { master:1, blank:1, live:1, click:1, ...(((override.sounds||{}).volume)||((theme.sounds||{}).volume)||{}) };
      theme.sounds.muted = !!((override.sounds||{}).muted ?? theme.sounds.muted);
    }
  }catch(e){ console.warn("localStorage èª­ã¿è¾¼ã¿å¤±æ•—", e); }

  applyThemeToDOM();
  renderPlayers();
  syncSoundUI();
}

function saveThemeToStorage(){
  try{
    localStorage.setItem(THEME_KEY, JSON.stringify(theme));
    alert("ä¿å­˜ã—ã¾ã—ãŸã€‚");
  }catch(e){ alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå®¹é‡è¶…éã®å¯èƒ½æ€§ï¼‰"); }
}
function resetTheme(){
  if(!confirm("UIè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  theme = JSON.parse(JSON.stringify(defaultTheme));
  applyThemeToDOM(); renderPlayers(); syncSoundUI();
}
function exportTheme(){
  const blob = new Blob([JSON.stringify(theme,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "sg_roulette_theme_v010.json";
  a.click();
  URL.revokeObjectURL(a.href);
}
function importTheme(file){
  const fr = new FileReader();
  fr.onload = () => {
    try{
      const data = JSON.parse(fr.result);
      theme = { ...defaultTheme, ...(data||{}) };
      applyThemeToDOM(); renderPlayers(); syncSoundUI();
      alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†");
    }catch(e){ alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šJSONå½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); }
  };
  fr.readAsText(file);
}
function applyThemeToDOM(){
  document.documentElement.style.setProperty("--bg-image", theme.background? `url(${theme.background})` : "none");
  document.documentElement.style.setProperty("--panel-image", theme.panel? `url(${theme.panel})` : "none");
  document.documentElement.style.setProperty("--flash-color", theme.flashColor || "#ffffff");
  // ã‚µã‚¦ãƒ³ãƒ‰URLã®é©ç”¨
  if(theme.sounds.blank) el("sndBlank").src = theme.sounds.blank;
  if(theme.sounds.live)  el("sndLive").src  = theme.sounds.live;
  if(theme.sounds.click) el("sndClick").src = theme.sounds.click;
  updateAudioVolumes();
}
function updateAudioVolumes(){
  const m = theme.sounds.volume?.master ?? 1;
  const vb = theme.sounds.volume?.blank ?? 1;
  const vl = theme.sounds.volume?.live ?? 1;
  const vc = theme.sounds.volume?.click ?? 1;
  const muted = !!theme.sounds.muted;
  const setVol = (id, v) => {
    const a = el(id);
    a.volume = muted ? 0 : Math.max(0, Math.min(1, v));
  };
  setVol("sndBlank", m * vb);
  setVol("sndLive",  m * vl);
  setVol("sndClick", m * vc);
}

/* ====================== è¨­å®šUIãƒ»ãƒ—ãƒªã‚»ãƒƒãƒˆ ====================== */
function fileToDataURL(file, cb){
  const fr = new FileReader();
  fr.onload = () => cb(fr.result);
  fr.readAsDataURL(file);
}
function openSettings(){
  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  el("bgPreview").style.backgroundImage = theme.background? `url(${theme.background})` : "none";
  el("panelPreview").style.backgroundImage = theme.panel? `url(${theme.panel})` : "none";
  el("flashColor").value = theme.flashColor || "#ffffff";

  ["p1Prev","p2Prev","p3Prev","p4Prev"].forEach((id,i)=>{
    const key = "P"+(i+1);
    el(id).style.backgroundImage = theme.avatars[key]? `url(${theme.avatars[key]})` : "none";
    el("p"+(i+1)+"Url").value = theme.avatars[key] || "";
  });

  const map = [["icoSaw","ãƒã‚³ã‚®ãƒª"],["icoGlass","æ‹¡å¤§é¡"],["icoBeer","ãƒ“ãƒ¼ãƒ«"],["icoSmoke","ã‚¿ãƒã‚³"],["icoCuff","æ‰‹éŒ "]];
  map.forEach(([id,label])=>{
    el(id+"Prev")?.style && (el(id+"Prev").style.backgroundImage = theme.icons[label]? `url(${theme.icons[label]})` : "none");
    el(id).value = theme.icons[label] || "";
  });

  // ã‚µã‚¦ãƒ³ãƒ‰UI
  syncSoundUI();
  el("settingsModal").style.display = "flex";
}
function closeSettings(){ el("settingsModal").style.display = "none"; }

function syncSoundUI(){
  el("sndBlankUrl").value = theme.sounds.blank || "";
  el("sndLiveUrl").value  = theme.sounds.live  || "";
  el("sndClickUrl").value = theme.sounds.click || "";
  el("volMaster").value = theme.sounds.volume.master ?? 1;
  el("volBlank").value  = theme.sounds.volume.blank ?? 1;
  el("volLive").value   = theme.sounds.volume.live  ?? 1;
  el("volClick").value  = theme.sounds.volume.click ?? 1;
  el("volMasterLabel").textContent = Math.round((theme.sounds.volume.master ?? 1)*100) + "%";
  el("volBlankLabel").textContent  = Math.round((theme.sounds.volume.blank ?? 1)*100) + "%";
  el("volLiveLabel").textContent   = Math.round((theme.sounds.volume.live  ?? 1)*100) + "%";
  el("volClickLabel").textContent  = Math.round((theme.sounds.volume.click ?? 1)*100) + "%";
  el("volMasterToolbar").value = theme.sounds.volume.master ?? 1;
  el("volMasterToolbarLabel").textContent = Math.round((theme.sounds.volume.master ?? 1)*100) + "%";
}

/* ====================== ã‚³ã‚¢ã‚²ãƒ¼ãƒ ï¼ˆÎ±0.3ç›¸å½“ã®å®‰å®šåŒ–ï¼‰ ====================== */
const ITEMS = ["ãƒã‚³ã‚®ãƒª","æ‹¡å¤§é¡","ãƒ“ãƒ¼ãƒ«","ã‚¿ãƒã‚³","æ‰‹éŒ "];

let state = {
  players: [], playerCount: 4, initHp: 5,
  chamber: [], chamberTotal: 0, round: 0,
  currentIndex: 0, peekInfo: null,
  autoNextOnEmptySelfShot: true
};

const el = id => document.getElementById(id);

function log(msg){
  const l = el("log");
  const time = new Date().toLocaleTimeString();
  l.innerHTML = `<div>[${time}] ${escapeHtml(msg)}</div>` + l.innerHTML;
}
function escapeHtml(s){ return s==null? "" : s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

function flash(){
  const f = el("flashOverlay");
  f.style.animation = "flashEffect 0.28s ease";
  f.onanimationend = () => { f.style.animation = ""; };
}

function initUI(){
  el("startBtn").onclick = startGame;
  el("resetBtn").onclick = resetAll;
  el("shootBtn").onclick = () => performShoot(false);
  el("shootSelfBtn").onclick = () => performShoot(true);
  el("endTurnBtn").onclick = endTurn;
  el("clearLog").onclick = () => el("log").innerHTML = "";

  // ã‚¿ã‚¤ãƒˆãƒ« â†’ ã‚²ãƒ¼ãƒ ã¸
  const title = el("titleScreen");
  const app = el("app");
  el("startBtnTitle").addEventListener("click", () => {
    // åˆå›ã‚¯ãƒªãƒƒã‚¯ã§åŠ¹æœéŸ³ã®è‡ªå‹•å†ç”Ÿåˆ¶é™ã‚’è§£é™¤ï¼ˆã‚¯ãƒªãƒƒã‚¯éŸ³ã‚’ä¸€å›é³´ã‚‰ã™ï¼‰
    playSound('click');
    title.style.display = "none";
    app.style.display = "block";
    startGame();
  });

  // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
  el("openSettings").onclick = ()=>{ playSound('click'); openSettings(); };
  el("closeSettings").onclick = closeSettings;
  el("settingsBackdrop").onclick = closeSettings;

  el("bgApply").onclick = () => {
    const url = (el("bgUrl").value || "").trim();
    theme.background = url || null; applyThemeToDOM();
    el("bgPreview").style.backgroundImage = url? `url(${url})` : "none";
  };
  el("panelApply").onclick = () => {
    const url = (el("panelUrl").value || "").trim();
    theme.panel = url || null; applyThemeToDOM();
    el("panelPreview").style.backgroundImage = url? `url(${url})` : "none";
  };
  el("flashTest").onclick = () => { flash(); };

  el("avatarsApply").onclick = () => {
    for(let i=1;i<=4;i++){
      const key = "P"+i;
      const url = (el("p"+i+"Url").value || "").trim();
      theme.avatars[key] = url || null;
    }
    renderPlayers();
  };
  el("iconsApply").onclick = () => {
    const map = [["icoSaw","ãƒã‚³ã‚®ãƒª"],["icoGlass","æ‹¡å¤§é¡"],["icoBeer","ãƒ“ãƒ¼ãƒ«"],["icoSmoke","ã‚¿ãƒã‚³"],["icoCuff","æ‰‹éŒ "]];
    map.forEach(([id,label]) => {
      const url = (el(id).value || "").trim();
      theme.icons[label] = url || null;
    });
    renderPlayers();
  };

  el("soundsApply").onclick = () => {
    theme.sounds.blank = (el("sndBlankUrl").value || "").trim() || null;
    theme.sounds.live  = (el("sndLiveUrl").value  || "").trim() || null;
    theme.sounds.click = (el("sndClickUrl").value || "").trim() || null;
    theme.sounds.volume.master = parseFloat(el("volMaster").value);
    theme.sounds.volume.blank  = parseFloat(el("volBlank").value);
    theme.sounds.volume.live   = parseFloat(el("volLive").value);
    theme.sounds.volume.click  = parseFloat(el("volClick").value);
    applyThemeToDOM();
  };
  el("testBlank").onclick = () => playSound('blank');
  el("testLive").onclick  = () => playSound('live');
  el("testClick").onclick = () => playSound('click');

  // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒã‚¹ã‚¿ãƒ¼éŸ³é‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒ»ãƒŸãƒ¥ãƒ¼ãƒˆ
  el("volMasterToolbar").addEventListener("input", ()=>{
    theme.sounds.volume.master = parseFloat(el("volMasterToolbar").value);
    el("volMasterToolbarLabel").textContent = Math.round(theme.sounds.volume.master*100)+"%";
    updateAudioVolumes();
  });
  el("muteToggle").onclick = ()=>{
    theme.sounds.muted = !theme.sounds.muted;
    el("muteToggle").textContent = theme.sounds.muted ? "ğŸ”ˆ ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤" : "ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ";
    updateAudioVolumes();
  };

  el("saveTheme").onclick = () => { theme.flashColor = el("flashColor").value || "#ffffff"; applyThemeToDOM(); saveThemeToStorage(); };
  el("resetTheme").onclick = () => { resetTheme(); saveThemeToStorage(); };
  el("exportTheme").onclick = exportTheme;
  el("importTheme").onclick = () => el("importThemeFile").click();
  el("importThemeFile").onchange = (e) => { const f = e.target.files[0]; if(f) importTheme(f); };
}

function resetAll(){
  state = {
    players: [],
    playerCount: parseInt(el("playerCount").value),
    initHp: parseInt(el("initHp").value),
    chamber: [], chamberTotal: 0, round: 0,
    currentIndex: 0, peekInfo: null, autoNextOnEmptySelfShot: true
  };
  updateUI();
  el("playersContainer").innerHTML = "";
  el("yourItems").innerHTML = "";
  el("peekArea").innerText = "ãªã—";
  log("ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
}
function startGame(){
  resetAll();
  state.playerCount = parseInt(el("playerCount").value);
  state.initHp = parseInt(el("initHp").value);
  let chamberSize = parseInt(el("chamberSize").value);
  let liveCount = parseInt(el("liveCount").value);
  if(!Number.isFinite(chamberSize) || chamberSize <= 0) chamberSize = 1;
  if(!Number.isFinite(liveCount) || liveCount < 0) liveCount = 0;
  if(liveCount > chamberSize){ liveCount = chamberSize; }

  state.players = [];
  for(let i=0;i<state.playerCount;i++){
    state.players.push({
      id: i, name: `P${i+1}`, hp: state.initHp, alive: true, items: [],
      skip: false, hasSawBuff: false
    });
  }
  state.round = 1;
  buildChamber(chamberSize, liveCount);
  distributeItemsToAll();
  state.currentIndex = 0; state.peekInfo = null;
  updateUI();
  log(`ã‚²ãƒ¼ãƒ é–‹å§‹ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°=${state.playerCount}, è–¬å®¤=${chamberSize}, å®Ÿå¼¾=${liveCount}`);
  announceTurn();
}
function buildChamber(size, liveCount){
  // Sanitize & clamp
  let s = parseInt(size); let l = parseInt(liveCount);
  if(!Number.isFinite(s) || s <= 0) s = 1;
  if(!Number.isFinite(l) || l < 0) l = 0;
  if(l > s) l = s;
  const arr = [];
  for(let i=0;i<l;i++) arr.push("live");
  for(let i=0;i<s-l;i++) arr.push("blank");
  shuffle(arr);
  state.chamber = arr;
  state.chamberTotal = s;
  el("chamberTotal").innerText = s;
  el("chamberRemain").innerText = state.chamber.length;
}
function distributeItemsToAll(){
  for(const p of state.players){
    if(!p.alive) continue;
    p.items = [];
    for(let i=0;i<3;i++){ p.items.push(randomOf(ITEMS)); }
  }
  renderPlayers();
  log(`ãƒ©ã‚¦ãƒ³ãƒ‰ ${state.round} é–‹å§‹ã€‚å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ãƒ©ãƒ³ãƒ€ãƒ ã§3ã¤ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é…å¸ƒã—ã¾ã—ãŸã€‚`);
}
function shuffle(a){ for(let i=a.length-1;i>0;i++){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function randomOf(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function renderPlayers(){
  const cont = el("playersContainer"); if(!cont) return;
  cont.innerHTML = "";
  for(let i=0;i<state.players.length;i++){
    const p = state.players[i];
    const div = document.createElement("div");
    div.className = "player" + (p.alive? "":" dead");
    div.id = "player_"+p.id;
    const itemsHtml = p.items.map((it, idx)=>{
      const iconUrl = theme.icons[it];
      const iconHtml = iconUrl ? `<span class="icon" style="background-image:url('${iconUrl}')"></span>` : "";
      return `<span class="item" data-player="${p.id}" data-idx="${idx}">${iconHtml}<span>${it}</span></span>`;
    }).join("");

    // ã‚¢ãƒã‚¿ãƒ¼ã¯ LS ã‚’æœ€å„ªå…ˆ
    const avatarUrl = theme.avatars["P"+(i+1)] || (theme.assetsAvatars? theme.assetsAvatars["P"+(i+1)] : null);
    const avatarStyle = avatarUrl? `background-image:url('${avatarUrl}')` : "";

    div.innerHTML = `
      <div class="avatar" style="${avatarStyle}"></div>
      <div>
        <div style="font-weight:700">${p.name} ${state.currentIndex===i? "â†":""}</div>
        <div>HP: <span class="hp">${p.hp}</span></div>
        <div>çŠ¶æ…‹: ${p.alive? "ç”Ÿå­˜":"è„±è½"}</div>
        <div class="items">ã‚¢ã‚¤ãƒ†ãƒ : ${itemsHtml}</div>
        <div style="margin-top:6px; font-size:13px;">${p.skip? "ï¼ˆæ¬¡ã‚¿ãƒ¼ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—äºˆå®šï¼‰": ""}</div>
      </div>
    `;
    cont.appendChild(div);
  }
  document.querySelectorAll('.item').forEach(elm=>{
    elm.onclick = (e) => {
      const pid = parseInt(elm.getAttribute('data-player'));
      const idx = parseInt(elm.getAttribute('data-idx'));
      if(pid !== state.currentIndex){ alert("è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã®æ™‚ã ã‘ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚"); return; }
      useItem(pid, idx);
    };
  });
  updateYourItems();
}
function updateYourItems(){
  const p = state.players[state.currentIndex];
  if(!p){ el("yourItems").innerHTML = "ãªã—"; return; }
  const area = el("yourItems");
  area.innerHTML = p.items.map((it, idx)=>{
    const iconUrl = theme.icons[it];
    const iconHtml = iconUrl ? `<span class="icon" style="width:16px;height:16px; background-image:url('${iconUrl}'); display:inline-block; vertical-align:-3px; margin-right:6px;"></span>` : "";
    return `<button data-idx="${idx}" data-player="${p.id}">${iconHtml}${it}</button>`;
  }).join(" ");
  area.querySelectorAll('button').forEach(btn=>{
    btn.onclick = () => {
      const idx = parseInt(btn.getAttribute('data-idx'));
      if(state.currentIndex !== parseInt(btn.getAttribute('data-player'))){ alert("è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã®æ™‚ã ã‘ä½¿ç”¨å¯èƒ½"); return; }
      useItem(state.currentIndex, idx);
    };
  });
}

function updateUI(){
  el("roundNo").innerText = state.round;
  el("chamberRemain").innerText = state.chamber.length;
  el("chamberTotal").innerText = state.chamberTotal;
  el("currentPlayer").innerText = state.players[state.currentIndex]? state.players[state.currentIndex].name : "-";
  el("peekState").innerText = state.peekInfo ? (state.peekInfo==="live"? "å®Ÿå¼¾":"ç©ºåŒ…") : "ä¸æ˜";
  renderPlayers();
  populateTargetSelect();
}
function populateTargetSelect(){
  const sel = el("targetSelect"); sel.innerHTML = "";
  const cur = state.players[state.currentIndex]; if(!cur) return;
  for(const p of state.players){
    if(!p.alive) continue;
    const opt = document.createElement("option");
    opt.value = p.id; opt.text = p.name + (p.id===cur.id? " (è‡ªåˆ†)":"");
    sel.add(opt);
  }
  let defaultIndex = 0;
  for(let i=0;i<sel.options.length;i++){
    if(parseInt(sel.options[i].value) !== cur.id){ defaultIndex = i; break; }
  }
  sel.selectedIndex = defaultIndex;
}

function announceTurn(){
  if(allDeadOrOneLeft()) return;
  while(state.players[state.currentIndex] && !state.players[state.currentIndex].alive){
    state.currentIndex = (state.currentIndex+1)%state.players.length;
  }
  const cur = state.players[state.currentIndex];
  if(!cur) return;
  if(cur.skip){
    log(`${cur.name} ã®ã‚¿ãƒ¼ãƒ³ã¯æ‰‹éŒ åŠ¹æœã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚`);
    cur.skip = false; advanceTurn(); return;
  }
  updateUI();
  log(`ã‚¿ãƒ¼ãƒ³: ${cur.name}`);
}

function performShoot(isSelf){
  const cur = state.players[state.currentIndex];
  if(!cur || !cur.alive){ log("è¡Œå‹•ã§ãã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚"); return; }
  if(state.chamber.length === 0){
    log("è–¬å®¤ãŒç©ºã§ã™ã€‚ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚");
    endRound(); return;
  }
  const targetId = isSelf ? cur.id : parseInt(el("targetSelect").value);
  const target = state.players.find(p=>p.id===targetId);
  if(!target || !target.alive){ alert("ç„¡åŠ¹ãªã‚¿ãƒ¼ã‚²ãƒƒãƒˆã§ã™ã€‚"); return; }

  const top = state.chamber.shift();
  state.peekInfo = null;
  el("peekArea").innerText = "ãªã—";
  el("chamberRemain").innerText = state.chamber.length;

  if(top === "blank"){
    playSound('blank');
    log(`${cur.name} ãŒ ${target.name} ã«ç™ºç ² â†’ ç©ºåŒ…ï¼ˆå®‰å¿ƒï¼‰ã€‚`);
    if(isSelf){
      log(`${cur.name} ã¯ç©ºåŒ…ã ã£ãŸãŸã‚ã€è¿½åŠ ã§è¡Œå‹•ã§ãã¾ã™ã€‚`);
      updateUI(); checkRoundEndAfterShot(); return;
    } else {
      checkRoundEndAfterShot(); advanceTurn(); return;
    }
  } else {
    playSound('live');
    flash();
    let dmg = 1;
    if(cur.hasSawBuff){
      dmg = 2; cur.hasSawBuff = false;
      log(`${cur.name} ã®ãƒã‚³ã‚®ãƒªåŠ¹æœã§ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ2å€ã«ãªã£ãŸï¼`);
    }
    target.hp -= dmg;
    log(`${cur.name} ãŒ ${target.name} ã«ç™ºç ² â†’ å®Ÿå¼¾ï¼ ${target.name} ã« ${dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚æ®‹HP=${Math.max(0,target.hp)}`);
    if(target.hp <= 0){ target.alive = false; log(`${target.name} ã¯è„±è½ã—ã¾ã—ãŸã€‚`); }
    checkRoundEndAfterShot(); advanceTurn(); return;
  }
}
function checkRoundEndAfterShot(){
  if(state.chamber.length === 0){
    log("ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®è–¬å®¤ã¯å…¨ã¦æ’ƒãŸã‚Œã¾ã—ãŸã€‚ãƒ©ã‚¦ãƒ³ãƒ‰çµ‚äº†ã§ã™ã€‚");
    endRound();
  } else { updateUI(); }
}
function endTurn(){ advanceTurn(); }
function advanceTurn(){
  if(allDeadOrOneLeft()) return;
  let next = state.currentIndex;
  for(let i=1;i<=state.players.length;i++){
    const cand = (state.currentIndex + i) % state.players.length;
    if(state.players[cand].alive){ next = cand; break; }
  }
  state.currentIndex = next; announceTurn();
}
function allDeadOrOneLeft(){
  const alive = state.players.filter(p=>p.alive);
  if(alive.length <= 1){
    if(alive.length === 1){ log(`ã‚²ãƒ¼ãƒ çµ‚äº†ï¼ å‹è€…: ${alive[0].name}`); }
    else { log("ã™ã¹ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè„±è½ã—ã¾ã—ãŸï¼ˆåŒæ™‚è„±è½ï¼‰ã€‚"); }
    updateUI(); return true;
  }
  return false;
}
function endRound(){
  const alive = state.players.filter(p=>p.alive);
  if(alive.length <= 1){ allDeadOrOneLeft(); return; }
  state.round += 1;
  const chamberSize = parseInt(el("chamberSize").value);
  const liveCount = parseInt(el("liveCount").value);
  buildChamber(chamberSize, liveCount);
  distributeItemsToAll();
  state.currentIndex = state.players.findIndex(p=>p.alive);
  announceTurn();
}

function useItem(pid, idx){
  const p = state.players[pid];
  if(!p || !p.alive){ alert("ä½¿ç”¨ä¸å¯"); return; }
  if(pid !== state.currentIndex){ alert("è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã®æ™‚ã ã‘ä½¿ãˆã¾ã™"); return; }
  const item = p.items[idx];
  if(!item){ alert("ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

  switch(item){
    case "ãƒã‚³ã‚®ãƒª": p.hasSawBuff = true; log(`${p.name} ã¯ ãƒã‚³ã‚®ãƒª ã‚’ä½¿ç”¨ã€‚æ¬¡ã«å‘½ä¸­ã™ã‚Œã°ãƒ€ãƒ¡ãƒ¼ã‚¸2å€ã€‚`); break;
    case "æ‹¡å¤§é¡":
      if(state.chamber.length === 0){ log("è–¬å®¤ãŒç©ºã®ãŸã‚è¦—ã‘ã¾ã›ã‚“ã€‚"); }
      else {
        const next = state.chamber[0]; state.peekInfo = next;
        el("peekArea").innerText = (next==="live"?"å®Ÿå¼¾":"ç©ºåŒ…");
        log(`${p.name} ã¯ æ‹¡å¤§é¡ ã‚’ä½¿ã„ã€å…ˆé ­å¼¾ãŒã€Œ${next==="live"?"å®Ÿå¼¾":"ç©ºåŒ…"}ã€ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã€‚`);
      }
      break;
    case "ãƒ“ãƒ¼ãƒ«":
      if(state.chamber.length===0){ log("è–¬å®¤ã«å¼¾ãŒãªã„ãŸã‚æ’è¢ã§ãã¾ã›ã‚“ã€‚"); }
      else {
        const removed = state.chamber.shift();
        log(`${p.name} ã¯ ãƒ“ãƒ¼ãƒ« ã‚’ä½¿ç”¨ã—ã€æ¬¡ã®å¼¾ã‚’æ’è¢ã—ãŸï¼ˆ${removed==="live"?"å®Ÿå¼¾ãŒå–ã‚Šé™¤ã‹ã‚ŒãŸ":"ç©ºåŒ…ãŒå–ã‚Šé™¤ã‹ã‚ŒãŸ"}ï¼‰ã€‚`);
        el("chamberRemain").innerText = state.chamber.length;
      }
      break;
    case "ã‚¿ãƒã‚³": p.hp += 1; log(`${p.name} ã¯ ã‚¿ãƒã‚³ ã‚’å–«ã¿ã€HPã‚’1å›å¾©ã€‚ï¼ˆç¾åœ¨HP=${p.hp}ï¼‰`); break;
    case "æ‰‹éŒ ":
      let nextOpp = null;
      for(let i=1;i<state.players.length;i++){
        const cand = (state.currentIndex + i) % state.players.length;
        if(state.players[cand].alive){ nextOpp = state.players[cand]; break; }
      }
      if(nextOpp){ nextOpp.skip = true; log(`${p.name} ã¯ æ‰‹éŒ  ã‚’ä½¿ç”¨ã€‚æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${nextOpp.name} ã®ã‚¿ãƒ¼ãƒ³ã‚’é£›ã°ã™ã€‚`); }
      else { log("ã‚¹ã‚­ãƒƒãƒ—å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚æ‰‹éŒ ã¯åŠ¹æœãŒãªã‹ã£ãŸã€‚"); }
      break;
    default: log("æœªå®šç¾©ã®ã‚¢ã‚¤ãƒ†ãƒ ");
  }

  p.items.splice(idx,1);
  renderPlayers(); updateYourItems(); updateUI();
  log(`ï¼ˆ${p.name} ã®ã‚¿ãƒ¼ãƒ³ç¶™ç¶šï¼šã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨ã¯ã‚¿ãƒ¼ãƒ³ã‚’æ¶ˆè²»ã—ã¾ã›ã‚“ï¼‰`);
}

/* ====================== ã‚µã‚¦ãƒ³ãƒ‰ç®¡ç† ====================== */
function playSound(name){
  const id = {blank:"sndBlank", live:"sndLive", click:"sndClick"}[name];
  if(!id) return;
  const a = el(id);
  if(a && a.src){ try{ a.currentTime = 0; a.play().catch(()=>{}); }catch(_e){} }
}

document.addEventListener("DOMContentLoaded", () => {
  // åˆæœŸãƒ­ãƒ¼ãƒ‰
  loadAssetsThenLocal().then(()=>{
    initUI();
  });
});
</script>

</body>
</html>
